name: Deploy Documentation

on:
  push:
    branches: [ "main" ]
    paths:
      - 'Sources/**/*.swift'
      - 'Documentation.docc/**'
      - 'Sources/**/*.docc/**'
      - 'Package.swift'
  workflow_dispatch:

jobs:
  deploy-docs:
    runs-on: macos-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - uses: actions/checkout@v4
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.4'
    
    - name: Generate Documentation
      run: |
        swift package --allow-writing-to-directory ./docs \
          generate-documentation --target MomentumCore \
          --disable-indexing \
          --transform-for-static-hosting \
          --hosting-base-path Momentum \
          --output-path ./docs
        
        echo "Documentation generated for GitHub Pages"
        
        # Generate documentation for other targets
        swift package --allow-writing-to-directory ./docs \
          generate-documentation --target MomentumAuthentication \
          --disable-indexing \
          --transform-for-static-hosting \
          --hosting-base-path Momentum \
          --output-path ./docs/authentication
        
        swift package --allow-writing-to-directory ./docs \
          generate-documentation --target MomentumUI \
          --disable-indexing \
          --transform-for-static-hosting \
          --hosting-base-path Momentum \
          --output-path ./docs/ui
        
        swift package --allow-writing-to-directory ./docs \
          generate-documentation --target MomentumFeatures \
          --disable-indexing \
          --transform-for-static-hosting \
          --hosting-base-path Momentum \
          --output-path ./docs/features
    
    - name: Create Index Page
      run: |
        # Create main index.html with navigation to all modules
        cat > ./docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Momentum Documentation</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 40px; }
                .module { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
                .module h2 { margin-top: 0; color: #007AFF; }
                .module a { text-decoration: none; color: #007AFF; }
                .module a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <h1>Momentum Documentation</h1>
            <p>Welcome to the Momentum app documentation. Choose a module to explore:</p>
            
            <div class="module">
                <h2><a href="./documentation/momentumcore/">MomentumCore</a></h2>
                <p>Core data models and shared utilities</p>
            </div>
            
            <div class="module">
                <h2><a href="./authentication/documentation/momentumauthentication/">MomentumAuthentication</a></h2>
                <p>Authentication services and user management</p>
            </div>
            
            <div class="module">
                <h2><a href="./ui/documentation/momentumui/">MomentumUI</a></h2>
                <p>Reusable UI components and views</p>
            </div>
            
            <div class="module">
                <h2><a href="./features/documentation/momentumfeatures/">MomentumFeatures</a></h2>
                <p>Main application features and screens</p>
            </div>
        </body>
        </html>
        EOF
        
        echo "Created main documentation index page"
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4